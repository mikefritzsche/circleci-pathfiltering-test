# .circleci/config.yml
version: 2.1

setup: true

orbs:
  path-filtering: circleci/path-filtering@0.1.3
  slack: circleci/slack@4.12.5

workflows:
  always-run:
    jobs:
      - path-filtering/filter:
          name: check-updated-files
          mapping: |
            server/.* run-server-workflow true
            web-portal/.* run-web-portal-workflow true
          base-revision: main
          config-path: .circleci/continue-config.yml
          context: slack-secrets
          post-steps:
            - slack/notify:
                event: pass
                channel: circleci-builds
                template: success_tagged_deploy_1
                custom: |
                  {
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "üîç Path Filter Check Complete",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": "*Branch:* $CIRCLE_BRANCH"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Build:* $CIRCLE_BUILD_NUM"
                          }
                        ]
                      },
                      {
                        "type": "section",
                        "text": {
                          "type": "mrkdwn",
                          "text": "Checking for changes in:\n‚Ä¢ Server code\n‚Ä¢ Web Portal code"
                        }
                      }
                    ]
                  }
            - slack/notify:
                event: fail
                channel: circleci-builds
                template: basic_fail_1
                custom: |
                  {
                    "blocks": [
                      {
                        "type": "header",
                        "text": {
                          "type": "plain_text",
                          "text": "‚ùå Path Filter Check Failed",
                          "emoji": true
                        }
                      },
                      {
                        "type": "section",
                        "fields": [
                          {
                            "type": "mrkdwn",
                            "text": "*Branch:* $CIRCLE_BRANCH"
                          },
                          {
                            "type": "mrkdwn",
                            "text": "*Build:* $CIRCLE_BUILD_NUM"
                          }
                        ]
                      }
                    ]
                  }
